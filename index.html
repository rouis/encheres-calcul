<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur Ench√®res & Historique</title>
    <style>
        :root {
            --primary: #007bff;
            --success: #28a745;
            --warning: #fd7e14;
            --danger: #dc3545;
            --bg: #f4f7f6;
            --text: #333;
        }
        body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 1100px; margin: 20px auto; padding: 15px; background: var(--bg); color: var(--text); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        
        .grid-forms { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .section { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
        h2 { margin-top: 0; font-size: 1.1rem; border-left: 4px solid var(--primary); padding-left: 10px; height: fit-content; }
        .section-or h2 { border-left-color: var(--success); }
        .section-market h2 { border-left-color: var(--warning); }
        
        label { display: block; margin-top: 10px; font-weight: 600; font-size: 0.85rem; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        
        button { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 14px; }
        .btn-calc { width: 100%; margin-top: auto; padding-top: 15px; background: var(--primary); color: white; }
        .btn-calc:hover { opacity: 0.9; }
        .btn-market { background: var(--warning); color: white; margin-top: 10px; }
        
        .result-box { margin-top: 15px; padding: 15px; border-radius: 8px; display: none; animation: fadeIn 0.3s; font-size: 0.9rem; }
        #resEnchere { background: #e7f1ff; border: 1px solid #b3d7ff; }
        #resGramme { background: #e9f7ef; border: 1px solid #c3e6cb; }
        #resMarket { background: #fff4e6; border: 1px solid #ffe8cc; display: block; }

        .price-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .price-row:last-child { border-bottom: none; }
        .price-val { font-weight: bold; color: var(--warning); }

        /* Historique */
        .history-container { margin-top: 30px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .history-actions { display: flex; gap: 8px; }
        
        .btn-action { background: #6c757d; color: white; padding: 8px 15px; font-size: 0.8rem; }
        .btn-clear { background: var(--danger); }
        
        .history-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .history-column { display: flex; flex-direction: column; }
        .history-column h4 { margin: 0 0 10px 0; font-size: 0.9rem; color: #666; text-transform: uppercase; letter-spacing: 1px; text-align: center; }

        .history-list { min-height: 50px; }
        .history-item { 
            background: white; 
            padding: 12px; 
            margin-bottom: 10px; 
            border-radius: 10px; 
            border-left: 5px solid #ccc; 
            font-size: 0.85rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            animation: fadeIn 0.3s;
        }
        .history-item.enchere { border-left-color: var(--primary); }
        .history-item.or { border-left-color: var(--success); }
        .history-item.market { border-left-color: var(--warning); }
        
        .item-content { flex-grow: 1; padding-right: 10px; }
        .item-meta { display: block; font-size: 0.7rem; color: #999; margin-top: 4px; }
        
        .btn-delete { background: none; color: #ddd; font-size: 1.1rem; padding: 0 5px; }
        .btn-delete:hover { color: var(--danger); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-forms, .history-grid { grid-template-columns: 1fr; }
        }

        @media print {
            body { background: white; margin: 0; padding: 0; }
            .section, .btn-calc, .btn-market, .history-actions, .btn-delete, h1, .btn-clear, .history-column h4 { display: none !important; }
            .history-grid { grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
            .history-item { border: 1px solid #eee; box-shadow: none; page-break-inside: avoid; }
        }
    </style>
</head>
<body>

    <h1>üõí Assistant d'Achat & M√©taux</h1>

    <div class="grid-forms">
        <!-- FORMULAIRE ENCH√àRES -->
        <div class="section section-enchere">
            <h2>üí∞ Frais de Vente</h2>
            <label>Prix adjug√© (‚Ç¨)</label>
            <input type="number" id="prix" placeholder="ex: 12000" inputmode="decimal">
            
            <label>Frais (%)</label>
            <select id="pourcentage">
                <option value="14.4">14.4% (Alcopa / VPauto)</option>
                <option value="14.28">14.28% (Judiciaire)</option>
                <option value="25">25% (Volontaire / Art)</option>
                <option value="custom">Autre % personnalis√©</option>
            </select>
            <input type="number" id="customPct" placeholder="Entrez %" style="display:none; margin-top:10px;" inputmode="decimal">

            <label>Frais fixes / Dossier (‚Ç¨)</label>
            <input type="number" id="fraisFixes" value="0" inputmode="decimal">
            
            <button class="btn-calc" onclick="calculerEnchere()">Calculer Ench√®re</button>
            
            <div id="resEnchere" class="result-box"></div>
        </div>

        <!-- FORMULAIRE OR -->
        <div class="section section-or">
            <h2>‚öñÔ∏è Prix au Gramme</h2>
            <label>Prix total pay√© (‚Ç¨)</label>
            <input type="number" id="prixArt" placeholder="ex: 850" inputmode="decimal">
            <label>Poids total (g)</label>
            <input type="number" id="poids" placeholder="ex: 15.4" inputmode="decimal">
            
            <button class="btn-calc" style="background: var(--success);" onclick="calculerGramme()">Calculer Or</button>
            
            <div id="resGramme" class="result-box"></div>
        </div>

        <!-- FORMULAIRE COURS DU MARCH√â -->
        <div class="section section-market">
            <h2>üìà Cours des M√©taux</h2>
            <div id="resMarket" class="result-box">
                <div id="marketContent">
                    <p style="text-align: center; color: #888;">Cliquez pour actualiser les cours r√©els</p>
                </div>
            </div>
            <button class="btn-market" id="btnUpdateMarket" onclick="updateMarketPrices()">üîÑ Actualiser les cours</button>
        </div>
    </div>

    <!-- HISTORIQUE S√âPAR√â -->
    <div class="history-container">
        <div class="history-header">
            <h3>üìú Historique des calculs</h3>
            <div class="history-actions">
                <button class="btn-action" onclick="copierHistorique()">üìã Copier Tout</button>
                <button class="btn-action" onclick="window.print()">üñ®Ô∏è PDF</button>
                <button class="btn-action btn-clear" onclick="viderHistorique()">üóëÔ∏è Vider</button>
            </div>
        </div>

        <div class="history-grid">
            <div class="history-column">
                <h4>V√©hicules & Lots</h4>
                <div id="histEnchere" class="history-list"></div>
            </div>

            <div class="history-column">
                <h4>Bijoux & M√©taux</h4>
                <div id="histGramme" class="history-list"></div>
            </div>

            <div class="history-column">
                <h4>Cours du March√©</h4>
                <div id="histMarket" class="history-list"></div>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; // La cl√© sera fournie par l'environnement
        const select = document.getElementById('pourcentage');
        const customInput = document.getElementById('customPct');
        const histEnchere = document.getElementById('histEnchere');
        const histGramme = document.getElementById('histGramme');
        const histMarket = document.getElementById('histMarket');

        select.onchange = () => customInput.style.display = (select.value === 'custom') ? 'block' : 'none';

        function ajouterAHistorique(type, texte) {
            const id = Date.now();
            const div = document.createElement('div');
            div.className = `history-item ${type}`;
            div.id = `item-${id}`;
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            div.innerHTML = `
                <div class="item-content">
                    <span>${texte}</span>
                    <span class="item-meta">Ajout√© √† ${time}</span>
                </div>
                <button class="btn-delete" onclick="supprimerItem(${id})">√ó</button>
            `;

            let targetList;
            if (type === 'enchere') targetList = histEnchere;
            else if (type === 'or') targetList = histGramme;
            else targetList = histMarket;
            
            targetList.prepend(div);
        }

        function supprimerItem(id) {
            const item = document.getElementById(`item-${id}`);
            if (item) {
                item.style.opacity = '0';
                item.style.transform = 'translateX(20px)';
                setTimeout(() => item.remove(), 250);
            }
        }

        function calculerEnchere() {
            const brute = parseFloat(document.getElementById('prix').value);
            const fixes = parseFloat(document.getElementById('fraisFixes').value) || 0;
            let pct = (select.value === 'custom') ? parseFloat(customInput.value) : parseFloat(select.value);

            if (isNaN(brute)) return alert("Veuillez indiquer un prix.");
            const montantPct = brute * (pct / 100);
            const total = brute + montantPct + fixes;

            const resBox = document.getElementById('resEnchere');
            resBox.style.display = 'block';
            resBox.innerHTML = `Total : <strong>${total.toFixed(2)} ‚Ç¨</strong><br><small>Frais : ${(montantPct + fixes).toFixed(2)}‚Ç¨</small>`;
            
            ajouterAHistorique('enchere', `üöó <b>Lot: ${brute.toLocaleString()}‚Ç¨</b> + ${pct}% + ${fixes}‚Ç¨ = <b>${total.toFixed(2)} ‚Ç¨</b>`);
        }

        function calculerGramme() {
            const p = parseFloat(document.getElementById('prixArt').value);
            const w = parseFloat(document.getElementById('poids').value);

            if (!p || !w) return alert("Remplissez le prix et le poids");

            const ratio = p / w;
            const resBox = document.getElementById('resGramme');
            resBox.style.display = 'block';
            resBox.innerHTML = `Ratio : <strong>${ratio.toFixed(2)} ‚Ç¨/g</strong>`;
            
            ajouterAHistorique('or', `‚öñÔ∏è <b>Or: ${p.toLocaleString()}‚Ç¨</b> / ${w}g = <b>${ratio.toFixed(2)} ‚Ç¨/g</b>`);
        }

        async function updateMarketPrices() {
            const btn = document.getElementById('btnUpdateMarket');
            const container = document.getElementById('marketContent');
            
            btn.disabled = true;
            btn.innerText = "‚åõ R√©cup√©ration...";
            container.innerHTML = `<p style="text-align:center;">Recherche des prix en direct...</p>`;

            const systemPrompt = "Tu es un expert en m√©taux pr√©cieux. Donne les prix actuels du march√© au gramme en EUR. R√©ponds UNIQUEMENT au format JSON : {'gold24k': 00.00, 'gold18k': 00.00, 'scrap18k': 00.00, 'silver': 0.00}. 'scrap18k' correspond au prix de rachat de l'or 18 carats (casse).";
            const userQuery = "Quels sont les prix actuels au gramme en France pour l'or 24k, 18k, la casse 18k et l'argent massif ?";

            let retries = 0;
            const maxRetries = 5;

            const fetchWithBackoff = async (delay) => {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userQuery }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            tools: [{ "google_search": {} }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    
                    if (!response.ok) throw new Error('API Error');
                    const result = await response.json();
                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    displayMarketPrices(data);
                } catch (error) {
                    if (retries < maxRetries) {
                        retries++;
                        setTimeout(() => fetchWithBackoff(delay * 2), delay);
                    } else {
                        container.innerHTML = `<p style="color:var(--danger); text-align:center;">Erreur lors de la r√©cup√©ration. R√©essayez.</p>`;
                        btn.disabled = false;
                        btn.innerText = "üîÑ R√©essayer";
                    }
                }
            };

            fetchWithBackoff(1000);
        }

        function displayMarketPrices(data) {
            const container = document.getElementById('marketContent');
            const btn = document.getElementById('btnUpdateMarket');
            
            const html = `
                <div class="price-row"><span>Or 24K (Pur)</span><span class="price-val">${data.gold24k} ‚Ç¨/g</span></div>
                <div class="price-row"><span>Or 18K (750)</span><span class="price-val">${data.gold18k} ‚Ç¨/g</span></div>
                <div class="price-row"><span>Casse Or 18K</span><span class="price-val">${data.scrap18k} ‚Ç¨/g</span></div>
                <div class="price-row"><span>Argent</span><span class="price-val">${data.silver} ‚Ç¨/g</span></div>
            `;
            container.innerHTML = html;
            btn.disabled = false;
            btn.innerText = "üîÑ Actualiser les cours";
            
            ajouterAHistorique('market', `üìà March√© : 24K: ${data.gold24k}‚Ç¨ | 18K: ${data.gold18k}‚Ç¨ | Argent: ${data.silver}‚Ç¨`);
        }

        function viderHistorique() {
            if(confirm("Effacer tout l'historique ?")) {
                histEnchere.innerHTML = "";
                histGramme.innerHTML = "";
                histMarket.innerHTML = "";
            }
        }

        function copierHistorique() {
            const lE = document.querySelectorAll('#histEnchere .history-item .item-content span:first-child');
            const lG = document.querySelectorAll('#histGramme .history-item .item-content span:first-child');
            const lM = document.querySelectorAll('#histMarket .history-item .item-content span:first-child');
            
            if (lE.length === 0 && lG.length === 0 && lM.length === 0) return alert("L'historique est vide.");
            
            let t = "--- R√âCAPITULATIF ---\n\n";
            if (lE.length > 0) { t += "üí∞ ENCH√àRES :\n"; lE.forEach(i => t += "- " + i.innerText + "\n"); t += "\n"; }
            if (lG.length > 0) { t += "‚öñÔ∏è OR / GRAMME :\n"; lG.forEach(i => t += "- " + i.innerText + "\n"); t += "\n"; }
            if (lM.length > 0) { t += "üìà COURS DU MARCH√â :\n"; lM.forEach(i => t += "- " + i.innerText + "\n"); }

            const el = document.createElement('textarea');
            el.value = t;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert("Copi√© !");
        }
    </script>
</body>
</html>
